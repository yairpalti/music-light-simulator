<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בקר תאורה מוסיקלי</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #888;
            font-size: 1.1rem;
        }

        .section {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #333;
        }

        .section h3 {
            margin-bottom: 16px;
            font-size: 1.4rem;
        }

        /* File upload */
        .file-upload {
            margin-bottom: 16px;
        }

        .file-input {
            width: 100%;
            padding: 12px;
            background: #333;
            border: 2px dashed #555;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input:hover {
            border-color: #4ecdc4;
            background: #444;
        }

        .file-status {
            margin-top: 12px;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .file-status.success {
            background: #2d5a3d;
            border: 1px solid #4ade80;
            color: #4ade80;
        }

        .file-status.error {
            background: #5a2d2d;
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        /* Audio test button */
        .audio-test {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: 3px solid #fcd34d;
            color: #000;
            font-weight: bold;
            margin-bottom: 16px;
        }

        .audio-test h4 {
            font-size: 1.3rem;
            margin-bottom: 8px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #000;
        }

        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
        }

        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .audio-level {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .level-bar {
            flex: 1;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }

        .level-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #fbbf24, #ef4444);
            transition: width 0.1s ease;
            border-radius: 4px;
        }

        .frequency-display {
            text-align: center;
            font-family: monospace;
            font-size: 1.8rem;
            color: #4ecdc4;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .setting {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .setting label {
            font-weight: 600;
            color: #ccc;
        }

        .setting select,
        .setting input[type="range"] {
            padding: 8px;
            background: #333;
            border: 1px solid #555;
            border-radius: 6px;
            color: #fff;
        }

        /* Light grid */
        .light-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
            max-width: 400px;
            margin: 0 auto;
            aspect-ratio: 1;
        }

        .light-dot {
            background: #444;
            border-radius: 6px;
            transition: all 0.1s ease;
            aspect-ratio: 1;
        }

        .light-dot.on {
            background: #fff;
            box-shadow: 0 0 15px rgba(255,255,255,0.6);
        }

        .pattern-info {
            text-align: center;
            margin-top: 16px;
            color: #888;
            font-size: 0.9rem;
        }

        /* Status */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            font-size: 0.9rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-indicator.active {
            background: #4ade80;
            box-shadow: 0 0 8px #4ade80;
        }

        .status-indicator.inactive {
            background: #666;
        }

        /* Audio player */
        .audio-player {
            background: #2a2a2a;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            cursor: pointer;
            margin: 12px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            border-radius: 3px;
            transition: width 0.1s ease;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 16px;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
        }

        .volume-slider {
            flex: 1;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .light-grid {
                max-width: 300px;
            }
        }

        /* Instructions */
        .instructions {
            background: linear-gradient(135deg, #1e3a8a, #1e40af);
            border: 1px solid #3b82f6;
        }

        .instructions ol {
            padding-right: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .instructions .step {
            background: #3b82f6;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🎵 בקר תאורה מוסיקלי</h1>
            <p>הופך מוסיקה לתצוגת אורות מרהיבה - גרסת GitHub Pages</p>
        </div>

        <!-- File Upload -->
        <div class="section">
            <h3>📁 העלאת קובץ שמע</h3>
            <input type="file" id="audioFile" accept="audio/*" class="file-input">
            <div id="fileStatus" class="file-status" style="display: none;"></div>
        </div>

        <!-- Audio Test -->
        <div class="section audio-test" id="audioTestSection" style="display: none;">
            <h4>🔊 בדיקת שמע</h4>
            <p>לחץ כאן תחילה כדי לוודא שהשמע עובד:</p>
            <button id="testAudioBtn" class="btn btn-warning">
                🎵 בדוק שמע עכשיו
            </button>
        </div>

        <!-- Audio Player -->
        <div class="section audio-player" id="audioPlayerSection" style="display: none;">
            <h3>🎵 נגן מוסיקה</h3>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="time-display">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
            <div class="player-controls">
                <button id="rewindBtn" class="btn">⏪ -10s</button>
                <button id="playPauseBtn" class="btn btn-primary">
                    ▶️ נגן מוסיקה + אורות
                </button>
                <button id="forwardBtn" class="btn">+10s ⏩</button>
            </div>
            <div class="volume-control">
                <span>🔊</span>
                <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.1" value="0.8">
                <span id="volumeDisplay">80%</span>
            </div>
        </div>

        <!-- Main Controls -->
        <div class="section">
            <h3>🎮 בקרה</h3>
            <div class="controls">
                <div class="control-group">
                    <button id="demoBtn" class="btn btn-primary">
                        ▶️ הדגמה (ללא קובץ)
                    </button>
                    <button id="beatBtn" class="btn btn-purple">
                        🎵 סימולציה של beat
                    </button>
                </div>
                
                <div class="control-group">
                    <label>רמת שמע</label>
                    <div class="audio-level">
                        <div class="level-bar">
                            <div class="level-fill" id="audioLevelBar"></div>
                        </div>
                        <span id="audioLevelText">0%</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>תדירות</label>
                    <div class="frequency-display" id="frequencyDisplay">0 Hz</div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div class="section">
            <h3>⚙️ הגדרות</h3>
            <div class="settings-grid">
                <div class="setting">
                    <label for="lightMode">מצב תאורה</label>
                    <select id="lightMode">
                        <option value="ALL_BEAT">כל הנקודות - פעימות</option>
                        <option value="INTENSITY">כל הנקודות - עוצמה</option>
                        <option value="RHYTHM">כל הנקודות - קצב</option>
                        <option value="BASS_SYNC">כל הנקודות - באס</option>
                    </select>
                </div>
                <div class="setting">
                    <label for="sensitivity">רגישות (<span id="sensitivityValue">50</span>%)</label>
                    <input type="range" id="sensitivity" min="10" max="100" value="50">
                </div>
            </div>
        </div>

        <!-- Light Grid -->
        <div class="section">
            <h3>💡 תצוגת רשת האורות</h3>
            <div class="light-grid" id="lightGrid">
                <!-- 100 dots will be generated by JavaScript -->
            </div>
            <div class="pattern-info" id="patternInfo">
                כל הנקודות דולקות וכבות יחד (לבן = דולק, אפור = כבוי)
            </div>
        </div>

        <!-- Status -->
        <div class="section">
            <h3>📊 סטטוס מערכת</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-indicator" id="musicStatus"></div>
                    <span>מוסיקה: <span id="musicStatusText">כבויה</span></span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="lightsStatus"></div>
                    <span>אורות: <span id="lightsStatusText">כבויים</span></span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="fileStatus"></div>
                    <span>קובץ: <span id="fileStatusText">לא נטען</span></span>
                </div>
                <div class="status-item">
                    <div class="status-indicator" id="beatStatus"></div>
                    <span>Beat: <span id="beatStatusText">לא זוהה</span></span>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="section instructions">
            <h3>📋 הוראות שימוש</h3>
            <ol>
                <li><span class="step">1</span>העלה קובץ MP3 או WAV מהמחשב</li>
                <li><span class="step">2</span>לחץ "🔊 בדוק שמע עכשיו" ווודא שאתה שומע</li>
                <li><span class="step">3</span>לחץ "▶️ נגן מוסיקה + אורות" לסינכרון מלא</li>
                <li><span class="step">4</span>התאם רגישות ומצב תאורה לפי הצורך</li>
                <li><span class="step">5</span>תהנה מהמופע! כל הנקודות יהבהבו עם המוסיקה</li>
            </ol>
        </div>
    </div>

    <script>
        // Global variables
        let audioElement = null;
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let animationId = null;
        let isPlaying = false;
        let isAudioPlaying = false;
        let sensitivity = 50;
        let lightMode = 'ALL_BEAT';
        let lightGrid = Array(10).fill().map(() => Array(10).fill(false));
        let demoInterval = null;

        // DOM elements
        const audioFileInput = document.getElementById('audioFile');
        const fileStatusDiv = document.getElementById('fileStatus');
        const audioTestSection = document.getElementById('audioTestSection');
        const audioPlayerSection = document.getElementById('audioPlayerSection');
        const testAudioBtn = document.getElementById('testAudioBtn');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const demoBtn = document.getElementById('demoBtn');
        const beatBtn = document.getElementById('beatBtn');
        const lightGridDiv = document.getElementById('lightGrid');
        const sensitivitySlider = document.getElementById('sensitivity');
        const lightModeSelect = document.getElementById('lightMode');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            createLightGrid();
            setupEventListeners();
        });

        function createLightGrid() {
            lightGridDiv.innerHTML = '';
            for (let i = 0; i < 100; i++) {
                const dot = document.createElement('div');
                dot.className = 'light-dot';
                dot.id = `dot-${i}`;
                lightGridDiv.appendChild(dot);
            }
        }

        function setupEventListeners() {
            audioFileInput.addEventListener('change', handleFileUpload);
            testAudioBtn.addEventListener('click', testAudio);
            playPauseBtn.addEventListener('click', togglePlayback);
            demoBtn.addEventListener('click', toggleDemo);
            beatBtn.addEventListener('click', simulateBeat);
            sensitivitySlider.addEventListener('input', updateSensitivity);
            lightModeSelect.addEventListener('change', updateLightMode);

            // Audio player controls
            document.getElementById('rewindBtn').addEventListener('click', () => seek(-10));
            document.getElementById('forwardBtn').addEventListener('click', () => seek(10));
            document.getElementById('progressBar').addEventListener('click', seekToPosition);
            document.getElementById('volumeSlider').addEventListener('input', updateVolume);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('File selected:', file.name, file.type);

            if (!file.type.startsWith('audio/')) {
                showFileStatus('❌ אנא בחר קובץ שמע תקין (MP3, WAV, etc.)', 'error');
                return;
            }

            const url = URL.createObjectURL(file);
            audioElement = new Audio(url);
            audioElement.volume = 0.8;

            audioElement.addEventListener('loadedmetadata', function() {
                console.log('Audio loaded successfully, duration:', audioElement.duration);
                showFileStatus(`✅ קובץ נטען: ${file.name} (${formatTime(audioElement.duration)})`, 'success');
                audioTestSection.style.display = 'block';
                audioPlayerSection.style.display = 'block';
                updateStatus('file', true);
                document.getElementById('totalTime').textContent = formatTime(audioElement.duration);
            });

            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('play', () => {
                isAudioPlaying = true;
                updateStatus('music', true);
                playPauseBtn.innerHTML = '⏸️ עצור מוסיקה + אורות';
            });
            audioElement.addEventListener('pause', () => {
                isAudioPlaying = false;
                updateStatus('music', false);
                playPauseBtn.innerHTML = '▶️ נגן מוסיקה + אורות';
            });
            audioElement.addEventListener('ended', () => {
                stopEverything();
            });
            audioElement.addEventListener('error', function(e) {
                console.error('Audio error:', e);
                showFileStatus('❌ שגיאה בטעינת הקובץ. נסה קובץ MP3 אחר.', 'error');
            });
        }

        function showFileStatus(message, type) {
            fileStatusDiv.textContent = message;
            fileStatusDiv.className = `file-status ${type}`;
            fileStatusDiv.style.display = 'block';
        }

        function testAudio() {
            if (!audioElement) {
                alert('❌ אנא העלה קובץ שמע תחילה');
                return;
            }

            console.log('Testing audio playback...');
            audioElement.currentTime = 0;
            audioElement.play()
                .then(() => {
                    console.log('Audio test successful');
                    alert('✅ השמע עובד מצוין! עכשיו תוכל לנגן עם אורות');
                    
                    // Stop after 3 seconds
                    setTimeout(() => {
                        audioElement.pause();
                        audioElement.currentTime = 0;
                    }, 3000);
                })
                .catch(error => {
                    console.error('Audio test failed:', error);
                    alert('❌ שגיאה בניגון: ' + error.message + '\nנסה ללחוץ על הדף תחילה ואז נסה שוב.');
                });
        }

        function togglePlayback() {
            if (isPlaying) {
                stopEverything();
            } else {
                if (audioElement) {
                    startAudioAnalysis();
                } else {
                    alert('❌ אנא העלה קובץ שמע תחילה או השתמש במצב הדגמה');
                }
            }
        }

        function startAudioAnalysis() {
            if (!audioElement) return;

            try {
                // Create audio context if needed
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                // Create analyser if needed
                if (!analyser) {
                    analyser = audioContext.createAnalyser();
                    const source = audioContext.createMediaElementSource(audioElement);
                    source.connect(analyser);
                    source.connect(audioContext.destination);
                    
                    analyser.fftSize = 256;
                    analyser.smoothingTimeConstant = 0.8;
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                }

                audioElement.currentTime = 0;
                audioElement.play();
                isPlaying = true;
                updateStatus('lights', true);
                analyzeAudio();

            } catch (error) {
                console.error('Error starting audio analysis:', error);
                alert('שגיאה בהתחלת ניתוח השמע: ' + error.message);
            }
        }

        function toggleDemo() {
            if (isPlaying && demoInterval) {
                stopEverything();
            } else {
                startDemo();
            }
        }

        function startDemo() {
            isPlaying = true;
            updateStatus('lights', true);
            demoBtn.innerHTML = '⏹️ עצור הדגמה';

            demoInterval = setInterval(() => {
                const time = Date.now() / 1000;
                const volume = (Math.sin(time * 2) + 1) / 2 * 0.8;
                const beat = Math.sin(time * 4) > 0.7;
                
                updateAudioLevel(volume);
                updateFrequency(200 + Math.sin(time * 0.5) * 100);
                updateStatus('beat', beat);
                
                generateLightPattern(volume, null, beat);
            }, 100);
        }

        function simulateBeat() {
            updateStatus('beat', true);
            updateAudioLevel(0.8);
            generateLightPattern(0.8, null, true);
            
            setTimeout(() => {
                updateStatus('beat', false);
            }, 200);
        }

        function analyzeAudio() {
            if (!analyser || !dataArray || !isPlaying) return;

            analyser.getByteFrequencyData(dataArray);
            
            // Calculate volume
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i] ** 2;
            }
            const volume = Math.sqrt(sum / dataArray.length) / 255;

            // Calculate dominant frequency
            let maxIndex = 0;
            for (let i = 0; i < dataArray.length; i++) {
                if (dataArray[i] > dataArray[maxIndex]) {
                    maxIndex = i;
                }
            }
            const frequency = (maxIndex * audioContext.sampleRate) / (2 * dataArray.length);

            // Simple beat detection
            const beatThreshold = (100 - sensitivity) / 100 * 0.4 + 0.2;
            const beat = volume > beatThreshold && Math.random() > 0.7;

            updateAudioLevel(volume);
            updateFrequency(frequency);
            updateStatus('beat', beat);
            
            generateLightPattern(volume, dataArray, beat);

            if (isPlaying) {
                animationId = requestAnimationFrame(analyzeAudio);
            }
        }

        function generateLightPattern(volume, freqData, beatDetected) {
            const threshold = (100 - sensitivity) / 100 * 0.5 + 0.1;
            let shouldLightUp = false;

            switch (lightMode) {
                case 'ALL_BEAT':
                    shouldLightUp = beatDetected || volume > threshold;
                    break;
                case 'INTENSITY':
                    shouldLightUp = volume > threshold;
                    break;
                case 'RHYTHM':
                    const time = Date.now() / 1000;
                    const rhythmPattern = Math.sin(time * 8) > 0 && volume > threshold * 0.7;
                    shouldLightUp = rhythmPattern || beatDetected;
                    break;
                case 'BASS_SYNC':
                    let bassLevel = 0;
                    if (freqData) {
                        bassLevel = freqData.slice(0, 15).reduce((a, b) => a + b, 0) / 15 / 255;
                    } else {
                        const time = Date.now() / 1000;
                        bassLevel = (Math.sin(time * 2.5) + 1) / 2 * volume;
                    }
                    shouldLightUp = bassLevel > threshold;
                    break;
            }

            // Update grid
            for (let y = 0; y < 10; y++) {
                for (let x = 0; x < 10; x++) {
                    lightGrid[y][x] = shouldLightUp;
                    const dotIndex = y * 10 + x;
                    const dot = document.getElementById(`dot-${dotIndex}`);
                    if (dot) {
                        dot.classList.toggle('on', shouldLightUp);
                    }
                }
            }
        }

        function stopEverything() {
            isPlaying = false;
            isAudioPlaying = false;
            
            if (audioElement) {
                audioElement.pause();
                audioElement.currentTime = 0;
            }
            
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            if (demoInterval) {
                clearInterval(demoInterval);
                demoInterval = null;
            }

            updateStatus('music', false);
            updateStatus('lights', false);
            updateStatus('beat', false);
            updateAudioLevel(0);
            updateFrequency(0);
            
            // Clear light grid
            for (let i = 0; i < 100; i++) {
                const dot = document.getElementById(`dot-${i}`);
                if (dot) dot.classList.remove('on');
            }

            playPauseBtn.innerHTML = '▶️ נגן מוסיקה + אורות';
            demoBtn.innerHTML = '▶️ הדגמה (ללא קובץ)';
        }

        function updateAudioLevel(level) {
            const percentage = Math.round(level * 100);
            document.getElementById('audioLevelBar').style.width = `${percentage}%`;
            document.getElementById('audioLevelText').textContent = `${percentage}%`;
        }

        function updateFrequency(freq) {
            document.getElementById('frequencyDisplay').textContent = `${Math.round(freq)} Hz`;
        }

        function updateStatus(type, active) {
            const indicator = document.getElementById(`${type}Status`);
            const text = document.getElementById(`${type}StatusText`);
            
            if (indicator) {
                indicator.classList.toggle('active', active);
                indicator.classList.toggle('inactive', !active);
            }
            
            if (text) {
                switch (type) {
                    case 'music':
                        text.textContent = active ? 'מתנגנת' : 'כבויה';
                        break;
                    case 'lights':
                        text.textContent = active ? 'פעילים' : 'כבויים';
                        break;
                    case 'file':
                        text.textContent = active ? 'נטען' : 'לא נטען';
                        break;
                    case 'beat':
                        text.textContent = active ? 'זוהה!' : 'לא זוהה';
                        break;
                }
            }
        }

        function updateSensitivity() {
            sensitivity = parseInt(sensitivitySlider.value);
            document.getElementById('sensitivityValue').textContent = sensitivity;
        }

        function updateLightMode() {
            lightMode = lightModeSelect.value;
        }

        function updateProgress() {
            if (!audioElement) return;
            
            const currentTime = audioElement.currentTime;
            const duration = audioElement.duration;
            
            if (duration > 0) {
                const percentage = (currentTime / duration) * 100;
                document.getElementById('progressFill').style.width = `${percentage}%`;
            }
            
            document.getElementById('currentTime').textContent = formatTime(currentTime);
        }

        function seekToPosition(event) {
            if (!audioElement) return;
            
            const rect = event.currentTarget.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            const newTime = percentage * audioElement.duration;
            
            audioElement.currentTime = newTime;
        }

        function seek(seconds) {
            if (!audioElement) return;
            
            const newTime = audioElement.currentTime + seconds;
            audioElement.currentTime = Math.max(0, Math.min(newTime, audioElement.duration));
        }

        function updateVolume() {
            const volume = parseFloat(document.getElementById('volumeSlider').value);
            if (audioElement) {
                audioElement.volume = volume;
            }
            document.getElementById('volumeDisplay').textContent = `${Math.round(volume * 100)}%`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && isPlaying) {
                // Page is hidden, pause everything
                stopEverything();
            }
        });

        // Handle audio context restrictions
        document.addEventListener('click', function() {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { once: true });
    </script>
</body>
</html>
